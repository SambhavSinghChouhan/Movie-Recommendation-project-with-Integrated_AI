<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Upcoming Movie ‚Äî RECOMMENDO</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg1:#0f1724; --bg2:#1f2937; --accent:#ffd36b; --muted:#9aa4b2;
    --card-bg: rgba(255,255,255,0.03);
    --glass: rgba(255,255,255,0.02);
    --ink: #fff; --line: #333;
  }
  html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
  /* Top Bar */
  .top-bar{
    position:sticky;top:0;z-index:50;
    display:flex;justify-content:space-between;align-items:center;
    padding:14px 22px;background:linear-gradient(180deg,#232323,#1b1b1b);
    border-bottom:1px solid var(--line);
    box-shadow:0 4px 16px rgba(0,0,0,.35);
  }
  .logo{margin:0;font-size:20px;letter-spacing:.12em;color:var(--ink)}
  .icons .icon{
    margin-left:12px;font-size:20px;text-decoration:none;color:var(--ink);
    padding:6px 8px;border-radius:10px;background:rgba(255,255,255,.04);
    transition:.18s ease-in-out;
  }
  .icons .icon:hover{background:rgba(255,255,255,.12);transform:translateY(-1px)}
  /* page wrap */
  .wrap{max-width:1100px;margin:18px auto;padding:18px}
  .card{display:flex;gap:28px;background:var(--card-bg);border-radius:14px;padding:22px;box-shadow:0 10px 30px rgba(2,6,23,0.6);align-items:flex-start;backdrop-filter: blur(4px); animation:cardIn .6s cubic-bezier(.2,.9,.3,1)}
  @keyframes cardIn{from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:none}}
  /* Poster */
  .poster{flex:0 0 320px}
  .poster img{width:100%;height:auto;border-radius:12px;object-fit:cover;box-shadow:0 18px 40px rgba(0,0,0,0.6);transition:transform .35s ease,filter .35s ease}
  .poster img:hover{transform:scale(1.03);filter:brightness(1.03)}
  /* Details */
  .details{flex:1;min-width:0}
  .title-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .title{font-size:28px;font-weight:700;color:var(--accent);margin:0 0 8px 0;line-height:1.05}
  .share-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:999px;color:#fff;cursor:pointer;font-size:16px}
  .meta-line{color:var(--muted);font-size:14px;margin-bottom:10px;display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .meta-line span{white-space:nowrap}
  .age{display:block;color:#9ef3c7;font-weight:600;margin-bottom:12px}
  .desc{color:#dbe6f0cc;line-height:1.6;margin-bottom:14px}
  .director{color:var(--muted);font-style:italic;margin-bottom:16px}
  /* Interested Button */
  .actions{display:flex;gap:12px;flex-wrap:wrap}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:10px 18px;border-radius:999px;color:#fff;font-weight:700;cursor:pointer;backdrop-filter: blur(4px);transition:all .22s ease}
  .btn:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,0.5);border-color:rgba(255,211,107,0.9);color:#0b1220;background:var(--accent)}
  .btn.active{background: rgba(255,211,107,0.12); border-color: rgba(255,211,107,0.6)}
  .note{color:var(--muted);margin-top:8px}
  @media (max-width:900px){.card{flex-direction:column;align-items:center}.poster{width:60%;flex-basis:auto}}
</style>
</head>
<body>
  <!-- Top bar -->
  <header class="top-bar">
    <h1 class="logo">RECOMMENDO</h1>
    <nav class="icons">
      <a href="searchpage.html" class="icon" title="Search">üîç</a>
      <a href="profilepage.php" class="icon" title="Profile">üë§</a>
      <a href="chatpage.html" class="icon" title="Chat with AI">üí¨</a>
    </nav>
  </header>

  <div class="wrap">
    <div id="movie-card" class="card" aria-live="polite">
      <div class="poster"><img id="posterImg" src="" alt="Poster"></div>

      <div class="details">
        <div class="title-row">
          <h1 class="title" id="movieTitle">Loading‚Ä¶</h1>
          <button id="shareBtn" class="share-btn" title="Share this movie">üîó</button>
        </div>

        <div class="meta-line">
          <span id="genreText">Genre</span>
          <span id="durationText">Duration</span>
          <span id="yearText">Year</span>
        </div>

        <div class="age" id="ageText">Age Rating</div>

        <div class="desc" id="descText">Description...</div>

        <div class="director" id="directorText">Directed by ...</div>

        <div class="actions" id="actionButtons">
          <button id="interestedBtn" class="btn">‚≠ê Interested <span id="interestedCount" style="margin-left:8px">0</span></button>
        </div>

        <div id="upcomingNote" class="note">This movie hasn't released yet. You can mark it as Interested.</div>
      </div>
    </div>
  </div>

<script>
(async function(){
  const movieId = new URLSearchParams(window.location.search).get('id');
  if (!movieId) { document.getElementById('movieTitle').innerText = 'Missing ?id=...'; return; }

  async function getState(){
    const res = await fetch(`moviepage.php?id=${movieId}`, { credentials: 'same-origin' });
    return await res.json();
  }
  async function postAction(payload){
    const form = new URLSearchParams();
    for (const k in payload) form.append(k, payload[k]);
    const res = await fetch('moviepage.php', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/x-www-form-urlencoded'},
      body: form.toString()
    });
    return await res.json();
  }

  function escapeHtml(s){ if (!s) return ''; return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }

  async function render(){
    const state = await getState();
    if (!state || state.error) {
      document.getElementById('movieTitle').innerText = state && state.error ? state.error : 'Error loading';
      return;
    }

    const m = state.movie || {};
    // If movie is released, redirect to released movie page
    if (m.release_status === 'released' || (m.release_date && new Date(m.release_date) <= new Date())) {
      window.location.href = 'moviepage.html?id=' + movieId;
      return;
    }

    // populate fields for upcoming
    document.getElementById('posterImg').src = m.poster_url || '';
    document.getElementById('movieTitle').textContent = m.title || '';
    document.getElementById('genreText').textContent = m.genre || '';
    document.getElementById('durationText').textContent = m.duration || '';
    document.getElementById('yearText').textContent = m.release_year || '';
    document.getElementById('ageText').textContent = m.age_rating ? `Age Rating: ${m.age_rating}` : '';
    document.getElementById('descText').textContent = m.description || '';
    document.getElementById('directorText').textContent = m.director ? `Directed by ${m.director}` : '';

    // interested count and button state
    document.getElementById('interestedCount').textContent = m.interested_count ?? (state.counts?.interested ?? 0);
    const flags = state.user_flags || {};
    document.getElementById('interestedBtn').classList.toggle('active', !!flags.interested);
  }

  // share button
  document.getElementById('shareBtn').addEventListener('click', async () => {
    const url = window.location.href;
    const title = document.getElementById('movieTitle').textContent || 'Movie';
    if (navigator.share) {
      try { await navigator.share({ title, url }); } catch(e) { /* user cancelled */ }
    } else {
      try {
        await navigator.clipboard.writeText(url);
        alert('Link copied to clipboard');
      } catch (e) {
        prompt('Copy this link', url);
      }
    }
  });

  // Interested toggle
  document.getElementById('interestedBtn').addEventListener('click', async () => {
    const res = await postAction({ action: 'toggle', status: 'interested', movie_id: movieId });
    if (res?.error) { alert(res.error); return; }
    // update UI from returned state
    const m = res.movie || {};
    document.getElementById('interestedCount').textContent = m.interested_count ?? (res.counts?.interested ?? 0);
    const flags = res.user_flags || {};
    document.getElementById('interestedBtn').classList.toggle('active', !!flags.interested);
  });

  // initial render
  await render();

})();
</script>
</body>
</html>
